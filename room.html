<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<title>Mötesrum Status</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<style>
html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    font-family: "Segoe UI", Arial, sans-serif;
    background: #f0f2f5;
    color: #333;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

header {
    background: #bebfc2;
    text-align: center;
    padding: 15px 0;
    font-size: 1.8em;
    font-weight: 600;
    color: #222;
}

#bookingInfo { text-align:center; font-size:1.5em; color:#555; margin-top:6px; }

#status {
    font-size: 12em;
    font-weight:700;
    text-align:center;
    margin: 7px auto;
}

.ledigt { color: #28a745; }
.upptaget { color: #dc3545; }

.container {
    display: flex;
    justify-content: space-around;
    margin: 20px;
    gap: 20px;
    flex: 1;
}

.column {
    flex: 1;
    min-width: 0;
    background:white;
    padding:15px;
    border-radius:10px;
    box-shadow:0 4px 10px rgba(0,0,0,0.1);
    display:flex;
    flex-direction:column;
}

.column h2 {
    border-bottom:2px solid #1a73e8;
    padding-bottom:8px;
    margin-bottom:12px;
    font-size:1.3em;
}

#todayMeetings, #tomorrowMeetings {
    flex:1;
    overflow-y:auto;
}

.meeting-card {
    padding:8px 12px;
    margin-bottom:8px;
    border-left:5px solid #1a73e8;
    background:#f8f9fa;
    border-radius:5px;
}
.meeting-card.ongoing { border-left-color:#dc3545; background:#ffe5e5; }
.meeting-time { font-weight:600; }
.attendees { font-size:0.85em; color:#555; margin-top:4px; }

/* Veckovy */
#weekContainer {
    display:none;
    position:absolute;
    top:0; left:0;
    width:100%; height:100%;
    background:#f0f2f5;
    z-index:999;
    display:flex;
    overflow-x:auto;
    gap:15px;
    padding:10px;
}

#weekContainer .column {
    min-width:250px;
    flex:0 0 auto;
    background:white;
    border-radius:10px;
    padding:15px;
    display:flex;
    flex-direction:column;
}

#weekContainer .column h2 {
    text-align:center;
    margin-bottom:15px;
    font-size:1.2em;
    color:#1a73e8;
}

.week-meeting-card {
    padding:15px;
    margin-bottom:12px;
    border-left:8px solid #1a73e8;
    border-radius:8px;
    background:#f8f9fa;
}
.week-meeting-card.ongoing { border-left-color:#dc3545; background:#ffe5e5; }
.week-meeting-time { font-weight:700; margin-bottom:5px; }
.week-attendees { font-size:0.85em; color:#555; }

#toggleWeekBtn { padding:10px 20px; font-size:1em; cursor:pointer; margin:10px auto; display:block; }
</style>
</head>
<body>

<header>Mötesrum</header>
<div id="bookingInfo"></div>
<div id="status">Laddar...</div>
<button id="toggleWeekBtn">Visa vecka</button>

<div class="container">
    <div class="column" id="todayColumn">
        <h2>Möten idag</h2>
        <div id="todayMeetings"></div>
    </div>
    <div class="column" id="tomorrowColumn">
        <h2>Möten imorgon</h2>
        <div id="tomorrowMeetings"></div>
    </div>
</div>

<div id="weekContainer"></div>

<script>
const API_URL = 'https://nodejs-serverless-function-express-beta-dusky.vercel.app/api/roomStatus';
let currentMeetings = [];

const toggleWeekBtn = document.getElementById("toggleWeekBtn");
const weekContainer = document.getElementById("weekContainer");
const standardContainer = document.querySelector(".container");
const statusEl = document.getElementById("status");

toggleWeekBtn.addEventListener("click", () => {
    if(weekContainer.style.display==="none"){
        weekContainer.style.display="flex";
        standardContainer.style.display="none";
        toggleWeekBtn.textContent="Stäng veckovy";
        renderWeekMeetings(weekContainer,currentMeetings);
    } else {
        weekContainer.style.display="none";
        standardContainer.style.display="flex";
        toggleWeekBtn.textContent="Visa vecka";
    }
});

async function fetchRoomData(roomEmail){
    try{
        const res = await fetch(`${API_URL}?room=${encodeURIComponent(roomEmail)}`);
        return await res.json();
    }catch{
        return {meetings:[],error:"Kunde inte kontakta API"};
    }
}

function renderWeekMeetings(containerEl, meetingsArr){
    containerEl.innerHTML="";
    const now = new Date();
    for(let i=0;i<7;i++){
        const dayDate = new Date(now);
        dayDate.setDate(now.getDate()+i);

        const dayColumn = document.createElement("div");
        dayColumn.className="column";
        dayColumn.innerHTML=`<h2>${dayDate.toLocaleDateString("sv-SE",{weekday:"long",day:"numeric",month:"numeric"})}</h2>`;

        const dayDiv = document.createElement("div");
        dayDiv.style.flex="1";
        dayDiv.style.overflowY="auto";
        dayColumn.appendChild(dayDiv);

        const dayMeetings = meetingsArr.filter(m => new Date(m.start.dateTime).toDateString()===dayDate.toDateString());

        dayMeetings.forEach(m=>{
            const div=document.createElement("div");
            const mStart=new Date(m.start.dateTime);
            const mEnd=new Date(m.end.dateTime);
            const ongoing=mStart<=now && now<=mEnd;

            div.className="week-meeting-card"+(ongoing?" ongoing":"");
            div.innerHTML=`
                <div class="week-meeting-time">${mStart.toLocaleTimeString("sv-SE",{hour:"2-digit",minute:"2-digit"})} - ${mEnd.toLocaleTimeString("sv-SE",{hour:"2-digit",minute:"2-digit"})}</div>
                <div>${m.subject}</div>
                <div class="week-attendees">Bokad av: ${m.organizer?.emailAddress?.name || "Okänd"}</div>
            `;
            dayDiv.appendChild(div);
        });

        containerEl.appendChild(dayColumn);
    }
}

async function updateStatus(){
    const urlParams = new URLSearchParams(window.location.search);
    const roomEmail = urlParams.get("room");
    const headerEl = document.querySelector("header");
    const bookingEl = document.getElementById("bookingInfo");
    const todayEl = document.getElementById("todayMeetings");
    const tomorrowEl = document.getElementById("tomorrowMeetings");

    if(!roomEmail){
        headerEl.textContent="Ingen rumsadress angiven";
        return;
    }

    const data = await fetchRoomData(roomEmail);
    if(data.error){
        headerEl.textContent=roomEmail;
        bookingEl.textContent='';
        todayEl.innerHTML=tomorrowEl.innerHTML="";
        return;
    }

    headerEl.textContent=data.displayName||roomEmail;
    bookingEl.textContent=`Bokas via: ${decodeURIComponent(roomEmail)}`;

    const now=new Date();
    const meetings=data.meetings||[];
    currentMeetings=meetings;

    const ongoing=meetings.find(m=>new Date(m.start.dateTime)<=now && now<=new Date(m.end.dateTime));
    if(statusEl){
        statusEl.textContent=ongoing?"Upptaget":"Ledigt";
        statusEl.className=ongoing?"upptaget":"ledigt";
    }

    function renderMeetings(containerEl, meetingsArr){
        containerEl.innerHTML="";
        meetingsArr.forEach(m=>{
            const div=document.createElement("div");
            const mStart=new Date(m.start.dateTime);
            const mEnd=new Date(m.end.dateTime);
            const ongoingMeeting=mStart<=now && now<=mEnd;
            div.className="meeting-card"+(ongoingMeeting?" ongoing":"");
            div.innerHTML=`
                <div class="meeting-time">${mStart.toLocaleTimeString("sv-SE",{hour:"2-digit",minute:"2-digit"})} - ${mEnd.toLocaleTimeString("sv-SE",{hour:"2-digit",minute:"2-digit"})}</div>
                <div>${m.subject}</div>
                <div class="attendees">Bokad av: ${m.organizer?.emailAddress?.name||"Okänd"}</div>
            `;
            containerEl.appendChild(div);
        });
    }

    const todayStr=now.toDateString();
    const tomorrowDate=new Date(now);
    tomorrowDate.setDate(tomorrowDate.getDate()+1);

    renderMeetings(todayEl, meetings.filter(m=>new Date(m.start.dateTime).toDateString()===todayStr));
    renderMeetings(tomorrowEl, meetings.filter(m=>new Date(m.start.dateTime).toDateString()===tomorrowDate.toDateString()));
}

updateStatus();
setInterval(updateStatus,60000);
</script>
</body>
</html>
