<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<title>Mötesrum Status</title>
<link rel="manifest" href="manifest.json">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<style>
html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    background: #f0f2f5;
    font-family: "Segoe UI", Arial, sans-serif;
    color: #333;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    user-select: none;
    -webkit-user-select: none;
    -webkit-touch-callout: none;
    -webkit-tap-highlight-color: transparent;
}

img, a { -webkit-user-drag: none; }

header {
    background: #bebfc2;
    text-align: center;
    padding: 15px 0;
    font-size: 1.8em;
    font-weight: 600;
    color: #222;
    flex-shrink: 0;
}

#bookingInfo {
    text-align: center;
    font-size: 1.5em;
    color: #555;
    margin-top: 6px;
}

#status {
    font-size: 12em;
    font-weight: 700;
    text-align: center;
    margin: 7px auto;
    transition: color 0.3s;
    flex-shrink: 0;
}

.ledigt { color: #28a745; }
.upptaget { color: #dc3545; }

/* ---- Veckovy ---- */
#weekContainer {
    display: flex;
    overflow-x: auto;
    flex: 1; /* fyller hela kvarvarande höjd */
    gap: 15px;
    padding: 10px;
    box-sizing: border-box;
}

#weekContainer .column {
    min-width: 250px;
    flex: 0 0 auto;
    background: white;
    border-radius: 10px;
    box-shadow: 0 6px 15px rgba(0,0,0,0.15);
    display: flex;
    flex-direction: column;
    padding: 15px;
    max-height: 100%;
}

#weekContainer .column h2 {
    text-align: center;
    margin-bottom: 15px;
    font-size: 1.2em;
    color: #1a73e8;
}

.week-meeting-card {
    padding: 15px;
    margin-bottom: 12px;
    border-left: 8px solid #1a73e8;
    border-radius: 8px;
    background: #f8f9fa;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    transition: transform 0.2s, box-shadow 0.2s;
}
.week-meeting-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
}
.week-meeting-card.ongoing {
    border-left-color: #dc3545;
    background: #ffe5e5;
}
.week-meeting-time { font-weight: 700; margin-bottom: 5px; }
.week-attendees { font-size: 0.85em; color: #555; }
</style>
</head>
<body>

<header>Mötesrum</header>
<div id="bookingInfo" aria-live="polite"></div>

<div id="weekContainer"></div>

<script>
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').then(() => console.log('Service Worker registrerad'))
    .catch(err => console.error('Service Worker fel:', err));
}

const API_URL = 'https://nodejs-serverless-function-express-beta-dusky.vercel.app/api/roomStatus';

async function fetchRoomData(roomEmail) {
    try {
        const res = await fetch(`${API_URL}?room=${encodeURIComponent(roomEmail)}`);
        return await res.json();
    } catch {
        return { meetings: [], error: "Kunde inte kontakta API" };
    }
}

// Render-funktion för veckovy
function renderWeekMeetings(containerEl, meetingsArr) {
    containerEl.innerHTML = "";
    const now = new Date();

    for (let i = 0; i < 7; i++) {
        const dayDate = new Date(now);
        dayDate.setDate(now.getDate() + i);

        const dayColumn = document.createElement("div");
        dayColumn.className = "column";
        dayColumn.innerHTML = `<h2>${dayDate.toLocaleDateString("sv-SE", { weekday:"long", day:"numeric", month:"numeric" })}</h2>`;

        const dayDiv = document.createElement("div");
        dayDiv.style.flex = "1";
        dayDiv.style.overflowY = "auto";
        dayColumn.appendChild(dayDiv);

        const dayMeetings = meetingsArr.filter(m => 
            new Date(m.start.dateTime).toDateString() === dayDate.toDateString()
        );

        dayMeetings.forEach(m => {
            const div = document.createElement("div");
            const mStart = new Date(m.start.dateTime);
            const mEnd = new Date(m.end.dateTime);
            const ongoing = mStart <= now && now <= mEnd;

            div.className = "week-meeting-card" + (ongoing ? " ongoing" : "");
            div.innerHTML = `
                <div class="week-meeting-time">
                    ${mStart.toLocaleTimeString("sv-SE",{hour:"2-digit",minute:"2-digit"})} - 
                    ${mEnd.toLocaleTimeString("sv-SE",{hour:"2-digit",minute:"2-digit"})}
                </div>
                <div>${m.subject}</div>
                <div class="week-attendees">Bokad av: ${m.organizer?.emailAddress?.name || "Okänd"}</div>
            `;
            dayDiv.appendChild(div);
        });

        containerEl.appendChild(dayColumn);
    }
}

// Hämta och rendera veckovy
async function updateWeekView() {
    const urlParams = new URLSearchParams(window.location.search);
    const roomEmail = urlParams.get("room");
    const headerEl = document.querySelector("header");
    const bookingEl = document.getElementById('bookingInfo');

    if (!roomEmail) {
        headerEl.textContent = "Ingen rumsadress angiven";
        return;
    }

    const data = await fetchRoomData(roomEmail);
    if (data.error) {
        headerEl.textContent = roomEmail;
        bookingEl.textContent = '';
        return;
    }

    headerEl.textContent = data.displayName || roomEmail;
    bookingEl.textContent = roomEmail ? `Bokas via: ${decodeURIComponent(roomEmail)}` : '';

    renderWeekMeetings(document.getElementById("weekContainer"), data.meetings || []);
}

updateWeekView();
setInterval(updateWeekView, 60000); // uppdatera varje minut
</script>

</body>
</html>
