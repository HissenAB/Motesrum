<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<title>Mötesrum Status</title>
<link rel="manifest" href="manifest.json">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<style>
html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    background: #f0f2f5;
    font-family: "Segoe UI", Arial, sans-serif;
    color: #333;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    user-select: none;
    -webkit-user-select: none;
    -webkit-touch-callout: none;
    -webkit-tap-highlight-color: transparent;
}

img, a { -webkit-user-drag: none; }

header {
    background: #bebfc2;
    text-align: center;
    padding: 15px 0;
    font-size: 1.8em;
    font-weight: 600;
    color: #222;
    flex-shrink: 0;
}

#bookingInfo {
    text-align: center;
    font-size: 1.5em;
    color: #555;
    margin-top: 6px;
}

#status {
    font-size: 12em;
    font-weight: 700;
    text-align: center;
    margin: 7px auto;
    transition: color 0.3s;
    flex-shrink: 0;
}

.ledigt { color: #28a745; }
.upptaget { color: #dc3545; }

.container {
    display: flex;
    justify-content: space-around;
    margin: 20px;
    gap: 20px;
    flex: 1;
    min-height: 0;
    padding-bottom: 20px;
    box-sizing: border-box;
}

.column {
    flex: 1;
    min-width: 0;
    background: white;
    padding: 15px;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    max-height: 100%;
}

.column h2 {
    border-bottom: 2px solid #1a73e8;
    padding-bottom: 8px;
    margin-bottom: 12px;
    font-size: 1.3em;
    font-weight: 600;
    flex-shrink: 0;
}

#todayMeetings, #tomorrowMeetings {
    flex: 1;
    overflow-y: auto;
    user-select: auto;
    -webkit-user-select: auto;
    touch-action: pan-y;
}

.meeting-card {
    padding: 8px 12px;
    margin-bottom: 8px;
    border-left: 5px solid #1a73e8;
    background: #f8f9fa;
    border-radius: 5px;
}
.meeting-card.ongoing {
    border-left-color: #dc3545;
    background: #ffe5e5;
}

.meeting-time { font-weight: 600; }
.attendees { font-size: 0.85em; color: #555; margin-top: 4px; }

.error {
    text-align: center;
    color: #dc3545;
    font-size: 1.8em;
    margin-top: 40px;
}

#installBtn { display: none; }

/* Veckovy */
#weekContainer {
    display: none;
    flex: 1;
    gap: 10px;
    padding: 10px;
    box-sizing: border-box;
    overflow: hidden;
    background: #f0f2f5;
}

/* Grid för exakt 5 kolumner */
#weekContainer.grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 10px;
}

#weekContainer .column {
    background: white;
    border-radius: 10px;
    box-shadow: 0 6px 15px rgba(0,0,0,0.15);
    display: flex;
    flex-direction: column;
    padding: 10px;
    max-height: 100%;
}

#weekContainer .column h2 {
    text-align: center;
    margin-bottom: 10px;
    font-size: 1.2em;
    color: #1a73e8;
}

.week-meeting-card {
    padding: 15px;
    margin-bottom: 12px;
    border-left: 8px solid #1a73e8;
    border-radius: 8px;
    background: #f8f9fa;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    transition: transform 0.2s, box-shadow 0.2s;
}
.week-meeting-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
}
.week-meeting-card.ongoing {
    border-left-color: #dc3545;
    background: #ffe5e5;
}
.week-meeting-time { font-weight: 700; margin-bottom: 5px; }
.week-attendees { font-size: 0.85em; color: #555; }

#showWeekBtn {
    padding: 10px 20px;
    font-size: 1em;
    border-radius: 5px;
    border: none;
    background: #1a73e8;
    color: white;
    cursor: pointer;
    margin: 10px auto;
    display: inline-block;
}
</style>
</head>
<body>

<header>Mötesrum</header>
<div id="bookingInfo" aria-live="polite"></div>
<div id="status">Laddar...</div>

<div style="text-align:center; margin:10px 0;">
    <button id="showWeekBtn">Visa kommande 5 dagar</button>
</div>

<div class="container" id="todayTomorrowContainer">
    <div class="column" id="todayColumn">
        <h2>Möten idag</h2>
        <div id="todayMeetings"></div>
    </div>
    <div class="column" id="tomorrowColumn">
        <h2>Möten imorgon</h2>
        <div id="tomorrowMeetings"></div>
    </div>
</div>

<div id="weekContainer" class="grid"></div>

<script>
if('serviceWorker' in navigator){
    navigator.serviceWorker.register('sw.js').then(()=>console.log('Service Worker registrerad'))
    .catch(err=>console.error('Service Worker fel:', err));
}

const API_URL='https://nodejs-serverless-function-express-beta-dusky.vercel.app/api/roomStatus';
let weekBaseDate=new Date();
let inWeekView=false;

async function fetchRoomData(roomEmail){
    try{
        const res=await fetch(`${API_URL}?room=${encodeURIComponent(roomEmail)}`);
        return await res.json();
    }catch{
        return {meetings:[], error:"Kunde inte kontakta API"};
    }
}

function renderMeetings(containerEl, meetingsArr, ongoing=null){
    containerEl.innerHTML="";
    meetingsArr.forEach(m=>{
        const div=document.createElement("div");
        div.className="meeting-card"+(m===ongoing?" ongoing":"");
        div.innerHTML=`
            <div class="meeting-time">
                ${new Date(m.start.dateTime).toLocaleTimeString("sv-SE",{hour:"2-digit",minute:"2-digit"})} - 
                ${new Date(m.end.dateTime).toLocaleTimeString("sv-SE",{hour:"2-digit",minute:"2-digit"})}
            </div>
            <div>${m.subject}</div>
            <div class="attendees">Bokad av: ${m.organizer?.emailAddress?.name||"Okänd"}</div>
        `;
        containerEl.appendChild(div);
    });
}

async function updateStatus(){
    if(inWeekView) return; // ignorera om vi är i veckovy
    const urlParams=new URLSearchParams(window.location.search);
    const roomEmail=urlParams.get("room");
    const statusEl=document.getElementById("status");
    const todayEl=document.getElementById("todayMeetings");
    const tomorrowEl=document.getElementById("tomorrowMeetings");
    const headerEl=document.querySelector("header");
    const bookingEl=document.getElementById('bookingInfo');

    if(!roomEmail){
        statusEl.style.display="none";
        headerEl.textContent="Ingen rumsadress angiven";
        return;
    }

    const data=await fetchRoomData(roomEmail);
    if(data.error){
        statusEl.style.display="none";
        todayEl.innerHTML=tomorrowEl.innerHTML="";
        headerEl.textContent=roomEmail;
        return;
    }

    headerEl.textContent=data.displayName||roomEmail;
    const now=new Date();
    const meetings=data.meetings||[];
    const ongoingMeeting=meetings.find(m=>new Date(m.start.dateTime)<=now && now<=new Date(m.end.dateTime));
    statusEl.textContent=ongoingMeeting?"Upptaget":"Ledigt";
    statusEl.className=ongoingMeeting?"upptaget":"ledigt";

    bookingEl.textContent=roomEmail?`Bokas via: ${decodeURIComponent(roomEmail)}`:'';

    const todayStr=now.toDateString();
    const tomorrow=new Date(now); tomorrow.setDate(tomorrow.getDate()+1);
    renderMeetings(todayEl, meetings.filter(m=>new Date(m.start.dateTime).toDateString()===todayStr), ongoingMeeting);
    renderMeetings(tomorrowEl, meetings.filter(m=>new Date(m.start.dateTime).toDateString()===tomorrow.toDateString()), ongoingMeeting);
}

function renderWeekMeetings(containerEl, meetingsArr){
    containerEl.innerHTML="";
    let dayCount=0, i=0;
    const now=new Date(weekBaseDate);
    while(dayCount<5){
        const dayDate=new Date(weekBaseDate);
        dayDate.setDate(weekBaseDate.getDate()+i);
        i++;
        const dayOfWeek=dayDate.getDay();
        if(dayOfWeek===0||dayOfWeek===6) continue; // hoppa helger
        dayCount++;

        const dayColumn=document.createElement("div");
        dayColumn.className="column";
        dayColumn.innerHTML=`<h2>${dayDate.toLocaleDateString("sv-SE",{weekday:"short",day:"numeric",month:"numeric"})}</h2>`;

        const dayDiv=document.createElement("div");
        dayDiv.style.flex="1";
        dayDiv.style.overflowY="auto";
        dayColumn.appendChild(dayDiv);

        const dayMeetings=meetingsArr.filter(m=>new Date(m.start.dateTime).toDateString()===dayDate.toDateString());
        dayMeetings.forEach(m=>{
            const mStart=new Date(m.start.dateTime);
            const mEnd=new Date(m.end.dateTime);
            const ongoing=mStart<=new Date() && new Date()<=mEnd;
            const div=document.createElement("div");
            div.className="week-meeting-card"+(ongoing?" ongoing":"");
            div.innerHTML=`
                <div class="week-meeting-time">${mStart.toLocaleTimeString("sv-SE",{hour:"2-digit",minute:"2-digit"})} - ${mEnd.toLocaleTimeString("sv-SE",{hour:"2-digit",minute:"2-digit"})}</div>
                <div>${m.subject}</div>
                <div class="week-attendees">Bokad av: ${m.organizer?.emailAddress?.name||"Okänd"}</div>
            `;
            dayDiv.appendChild(div);
        });

        containerEl.appendChild(dayColumn);
    }
}

// Bläddra veckor
function changeWeek(offset){
    weekBaseDate.setDate(weekBaseDate.getDate()+offset*7);
    updateWeekView();
}

async function updateWeekView(){
    inWeekView=true;
    document.getElementById("todayTomorrowContainer").style.display="none";
    document.getElementById("status").style.display="none";
    document.getElementById("weekContainer").style.display="grid";

    const urlParams=new URLSearchParams(window.location.search);
    const roomEmail=urlParams.get("room");
    const headerEl=document.querySelector("header");
    const bookingEl=document.getElementById('bookingInfo');

    if(!roomEmail){
        headerEl.textContent="Ingen rumsadress angiven";
        return;
    }

    const data=await fetchRoomData(roomEmail);
    if(data.error){
        headerEl.textContent=roomEmail;
        bookingEl.textContent="";
        return;
    }

    headerEl.textContent=data.displayName||roomEmail;
    bookingEl.textContent=roomEmail?`Bokas via: ${decodeURIComponent(roomEmail)}`:'';

    renderWeekMeetings(document.getElementById("weekContainer"), data.meetings||[]);
}

// Veckovy-knapp
document.getElementById("showWeekBtn").addEventListener("click", ()=>{
    if(!inWeekView){
        weekBaseDate=new Date();
        updateWeekView();
        document.getElementById("showWeekBtn").textContent="Tillbaka till status";
    }else{
        inWeekView=false;
        document.getElementById("weekContainer").style.display="none";
        document.getElementById("todayTomorrowContainer").style.display="flex";
        document.getElementById("status").style.display="block";
        document.getElementById("showWeekBtn").textContent="Visa kommande 5 dagar";
        updateStatus();
    }
});

// Scroll-återställning
let scrollTimer;
function resetScrollTimerFull(){
    if(scrollTimer) clearTimeout(scrollTimer);
    scrollTimer=setTimeout(()=>{
        inWeekView=false;
        document.getElementById("weekContainer").style.display="none";
        document.getElementById("todayTomorrowContainer").style.display="flex";
        document.getElementById("status").style.display="block";
        document.getElementById("showWeekBtn").textContent="Visa kommande 5 dagar";
        updateStatus();
        window.scrollTo({top:0,behavior:"smooth"});
    }, 7000);
}

// Starta scroll-timer
document.addEventListener("DOMContentLoaded", resetScrollTimerFull);
['todayMeetings','tomorrowMeetings','weekContainer'].forEach(id=>{
    const el=document.getElementById(id);
    el.addEventListener("scroll", resetScrollTimerFull);
});

updateStatus();
setInterval(updateStatus,60000);
setInterval(()=>{ const url=new URL(window.location.href); url.searchParams.set('t',Date.now()); window.location.href=url.toString();},30*60*1000);
</script>
</body>
</html>
